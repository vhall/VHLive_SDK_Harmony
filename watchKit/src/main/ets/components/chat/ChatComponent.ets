import { ComponentContent, KeyboardAvoidMode } from '@kit.ArkUI';
import {
  VHGiftMessageInfo,
  VHLikeIcon,
  VHQuestionAnswerSwitchMsg,
  VHQuestionnairePushModel,
  VHRoomLikeInfo,
  VHRoomToolsStatusData,
  VHAgreement,
  VHChatDisableAllMsg,
  VHChatMessageList,
  VHConfigList,
  VHContent,
  VHContext,
  VHExaminationModel,
  VHIMMessageModel,
  VHIMServer,
  VHMsgData,
  VHReplyMessage,
  VHReplyMessageContent,
  VHRoomEventType,
  VHSaaSDK,
  VHUploadFileInfo,
  VHUserData,
  VHWebinarData,
  VHExamUserAnswerStatus,
  VHExamRank,
  VHExamReportList,
  VHChatDeleteMsg,
  VHChatMsgSetRecommend,
  VHChatMsgDelRecommend,
  VHExamList,
} from '@vhall/vhall_live';
import { EmitterMsgData, EmitterUtil } from '../../util/EmitterUtil';
import { ToastUtil } from '../../action/ToastUtil';
import { createGiftView } from './GiftComponent';
import { PromptActionClass } from '../../util/PromptActionClass';
import ChatTools from '../../util/ChatTools';
import { CountDownTimer } from '../../util//CountDownTimer.ets';
import { EmojiTool } from './EmojiTool';
import { QuestionnaireBuilder } from '../../builder/QuestionnaireBuilder';
import { ExamBuilder } from '../../builder/ExamBuilder';
import { ToastOptions } from '../../entity/ToastOptions';
import LoadingMoreView from '../../components/common/LoadingMoreView';
import fs from '@ohos.file.fs';
import { util } from '@kit.ArkTS';
import { picker } from '@kit.CoreFileKit';
import MsgType from '../../constants/MsgType';
import { createExamReportView, reportParams } from '../../builder/ExamReportBuilder';


/**
 * ä¸»ç•Œé¢ï¼ˆèŠå¤©å•é¡µï¼‰ã€‚
 *
 */
@Component
export struct ChatComponent {
  @Prop functionConfig: VHConfigList | null = null; //åŠŸèƒ½é…ç½®
  @Prop room_tool: VHRoomToolsStatusData | null = null;
  @Prop webinars: VHWebinarData | null = null;
  @Prop isLive: boolean; //æ˜¯å¦ç›´æ’­
  @Prop welcomeContent: string;
  @Prop imBase: VHIMServer;
  @State avatar: string | undefined = "";
  @State inputText: string = "å‚ä¸èŠå¤©";
  @State messageInput: string = '';
  @LocalStorageLink('likeCount') likeCount: number = 0;
  @State clickLikeNumber: number = 0;
  @Consume questionnairePush: VHQuestionnairePushModel | null
  @Consume examData: VHExaminationModel
  @Consume chatBannedMode:number;
  private examReportContentNode: ComponentContent<Object> | null = null;
  @Consume ExamList: VHExamList[]
  /** èŠå¤©åˆ—è¡¨çš„æ»šåŠ¨æ¡ç»„ä»¶ */
  private scroller: Scroller = new Scroller();
  private giftNode: ComponentContent<Object> | null = null;
  private timer: CountDownTimer | null = null;
  @State chatDisable: boolean = false;
  /** èŠå¤©æ¶ˆæ¯åˆ—è¡¨å¯¹åº”çš„æ•°æ®æºå¯¹è±¡ï¼ˆæœ¬å¯¹è±¡ä¸MessageProvideré…åˆï¼Œç”¨äºå®ç°UIç•Œé¢ä¸æ•°æ®ç»„çš„è§£å¶ï¼‰*/
  @State historyData: VHContent[] = [];
  @State examRankMsg: VHExamRank[] = [];
  // ç”¨æ¥é…ç½®CanvasRenderingContext2Då¯¹è±¡çš„å‚æ•°ï¼Œå¼€å¯æŠ—é”¯é½¿
  private settings: RenderingContextSettings = new RenderingContextSettings(true)
  // æ­£ç¡®åˆ›å»ºCanvasRenderingContext2Då¯¹è±¡
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings)
  @State likeIcons: VHLikeIcon[] = [] // å­˜å‚¨æ‰€æœ‰ç‚¹èµå›¾æ ‡
  @State welcomeLoginUser: string = '';
  @State agreement: VHAgreement = new VHAgreement();
  private animationId: number = 0 // åŠ¨ç”»ID
  @Consume chatNickNameEnc:number;
  // emojiè¡¨æƒ…æ•°ç»„
  private readonly emojis: string[] = [
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ',
    'ğŸ¼', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦Š',
    'ğŸ', 'ğŸ€', 'ğŸ‰', 'ğŸŠ', 'âœ¨', 'â­'
  ]
  // çŠ¶æ€ç®¡ç†ï¼šæ§åˆ¶é¢„è§ˆæ˜¾ç¤º/éšè— + å½“å‰é¢„è§ˆçš„å›¾ç‰‡URL
  @State isPreviewShow: boolean = false;
  @State currentPreviewUrl: string = '';
  @State reachStatus: number = 0 //è§¦åº•çŠ¶æ€ 0:åˆå§‹çŠ¶æ€ï¼Œ1ï¼šåŠ è½½ä¸­çŠ¶æ€ 2ï¼šå·²åˆ°åº•äº†
  @State isLoadingMore: boolean = false //æ˜¯å¦æ­£åœ¨é€šè¿‡æ¥å£è¯·æ±‚åŠ è½½æ•°æ®
  @State hasMoreData: boolean = true
  @State initCompleted: boolean = false //åˆå§‹åŒ–æ˜¯å¦å®Œæˆ
  @State loadingMoreVisible: boolean = false //åŠ è½½æ›´å¤šç»„ä»¶æ˜¯å¦æ˜¾ç¤º
  @State isRefreshing: boolean = false
  private total: number = 0
  private pageSize: number = 100 //åˆ†é¡µæ¯é¡µä¸ªæ•°
  private pageNo: number = 1 //åˆ†é¡µå½“å‰é¡µæ•°
  private lastScrollOffset: number = 0
  // æ·»åŠ é˜²é‡æ ‡å¿—
  private isHandlingReachEnd: boolean = false
  @State enableWelcome:boolean = false;
  @State welcomeMsg:string = "";

  aboutToAppear() {
    // æœ¬ç•Œé¢æ˜¾ç¤ºæ—¶ï¼Œå°†è¾“å…¥æ³•è½¯é”®ç›˜é¿è®©æ¨¡å¼è®¾ç½®ä¸ºKeyboardAvoidMode.RESIZEï¼ˆå³å‹ç¼©çª—ä½“ï¼Œè€Œä¸æ˜¯å°†çª—ä½“æ•´ä½“ä¸Šç§»ï¼‰
    // this.setKeyboardAvoidModeToRESIZE(this.getUIContext(), true);
    this.avatar = this.webinars?.join_info?.avatar;
    this.initChatMessage(1);
    this.getLikeCount();
    // å¯åŠ¨åŠ¨ç”»å¾ªç¯
    this.startAnimation()
    this.initTimer();
    this.enableWelcome = this.functionConfig?.live_chat_welcome == 1 ? true : false;
    this.welcomeMsg = this.functionConfig?.live_chat_welcome_msg!;
    this.giftNode = new ComponentContent(this.getUIContext(), wrapBuilder(createGiftView), this.webinars!);
    // PromptActionClass.setContext(this.getUIContext());
    // PromptActionClass.setContentNode(this.giftNode);
    // PromptActionClass.setOptions({ alignment: DialogAlignment.BottomEnd, offset: { dx: 0, dy: 0 } });
    // è®¢é˜…æ¶ˆæ¯
    this.subscribeTextMessage();
    this.subscribeGiftMessage();
    this.subscribePaperEndMessage();
    this.subLotteryMsg();
    this.subscribeChatDisable();
    this.subscribeLikeCount();
    this.subscribeClearAllChatMessage();
    this.subscribeChatDelete();
    this.subscribeChatMsgSetRecommend();
    this.subscribeChatMsgDelRecommend();
    if (this.isLive) {
      this.subscribeQuestionAnswerMessage();
      this.welcomeUser();
    }
    if (this.room_tool?.all_banned == 1 || this.webinars?.join_info?.is_gag == 1) {
      this.chatDisable = true;
    }
    if (this.isLive == false && this.functionConfig?.watch_record_no_chatting == 1) {
      // å›æ”¾ç¦è¨€
      this.chatDisable = true;
    }
    this.AgreementMessage();
  }

  /**
   * ç•Œé¢è¢«é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚
   */
  aboutToDisappear() {
    // this.setKeyboardAvoidModeToRESIZE(this.getUIContext(), false);
    this.timer?.cancel();
    // æ¸…é™¤åŠ¨ç”»å¾ªç¯
    clearInterval(this.animationId)
    EmitterUtil.unsubscribe(VHRoomEventType.IM_TEXT);
    EmitterUtil.unsubscribe(VHRoomEventType.GIFT_MSG);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_OPEN);
    EmitterUtil.unsubscribe(VHRoomEventType.USER_JOIN);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_DISABLE);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_PERMIT);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_DISABLE_ALL);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_PERMIT_ALL);
    EmitterUtil.unsubscribe(VHRoomEventType.CUSTOM_PRAISE);
    EmitterUtil.unsubscribe(MsgType.LOTTERY_MSG);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_DELETE);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_MSG_SET_RECOMMEND);
    EmitterUtil.unsubscribe(VHRoomEventType.CHAT_MSG_DEL_RECOMMEND);
  }

  //é—®å·å¼¹çª—
  VHQuestionnaireDialog = new CustomDialogController({
    builder: QuestionnaireBuilder({ webinar: this.webinars! }),
    customStyle: true,
    alignment: DialogAlignment.Bottom
  })
  //å¿«é—®å¿«ç­”å¼¹çª—
  VHExamDialog = new CustomDialogController({
    builder: ExamBuilder({webinar_info:this.webinars!}),
    customStyle: true,
    alignment: DialogAlignment.Bottom
  })

  //è§‚çœ‹åè®®æ¶ˆæ¯
  AgreementMessage() {
    if (this.webinars?.webinar != null) {
      let recordId:string = "";
      if(this.webinars.webinar.type == 5){
        recordId = this.webinars.record?.record_id!;//å›æ”¾è·å–å½“å‰å›æ”¾id
      }
      VHSaaSDK.getInstance().getWatchInfo(this.webinars.webinar.id.toString(), recordId, '', '',  {
        onSucceed: (data: VHWebinarData) => {
          this.agreement = data.agreement as VHAgreement;
        },
        onFailure: (errorCode, errorMsg) => {
          ToastUtil.showToast(errorMsg);
        }
      })
    }
  }

  // æ¬¢è¿è¯­
  welcomeUser() {
    this.welcomeLoginUser = this.webinars?.join_info?.nickname!;
    let options: ToastOptions = new ToastOptions();
    options.alignment = Alignment.Center;
    options.backgroundColor = '#FF8A80';
    options.offset = { dx: 0, dy: -300 }
    // if (this.welcomeLoginUser! && this.welcomeContent.length > 0) {
    //   ToastUtil.showToast(this.welcomeLoginUser + " " + this.welcomeContent, options);
    // }
    if(this.enableWelcome){
      let tips = this.welcomeMsg.replace("{user_nickname}",this.welcomeLoginUser);
      ToastUtil.showToast(tips, options);
    }
  }

  // è®¢é˜…Textç±»å‹æ¶ˆæ¯
  subscribeTextMessage() {
    EmitterUtil.subscribe(VHRoomEventType.IM_TEXT, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.IM_TEXT}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        // å®é™…ä¸šåŠ¡ï¼šå°†æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨ã€æ›´æ–°UIç­‰
        this.handleTextMessage(messageModel.data);
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });
  }

  subscribePaperEndMessage() {
    EmitterUtil.subscribe(VHRoomEventType.PAPER_SEND_RANK, (msgData: EmitterMsgData) => {
      let messageModel: VHExamRank = msgData.data as VHExamRank;
      this.examRankMsg.push(messageModel)
      setTimeout(() => {
        this.scrollToBottom();
      }, 100);
    });
  }



  subscribeLikeCount() {
    EmitterUtil.subscribe(VHRoomEventType.CUSTOM_PRAISE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°ç‚¹èµæ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.IM_TEXT}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        this.handleLikeCount(messageModel.data);
      }
    });
  }

  subscribeChatDelete() {
    EmitterUtil.subscribe(VHRoomEventType.CHAT_DELETE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°åˆ é™¤æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.CHAT_DELETE}`);
      let chatDeleteMsg: VHChatDeleteMsg = msgData.data as VHChatDeleteMsg;
      if (chatDeleteMsg!) {
        if (typeof chatDeleteMsg === 'string') {
          const parsedMessage: VHChatDeleteMsg = JSON.parse(chatDeleteMsg) as VHChatDeleteMsg;
          this.handleChatDeleteMsg(parsedMessage);
        } else {
          this.handleChatDeleteMsg(chatDeleteMsg);
        }
      }
    });
  }

  subscribeClearAllChatMessage() {
    EmitterUtil.subscribe(VHRoomEventType.CLEAR_CHAT_MESSAGE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.CLEAR_CHAT_MESSAGE}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        // é‡æ–°åˆå§‹åŒ–æ¶ˆæ¯
        this.initChatMessage(1);
      }
    });
  }

  subscribeChatMsgSetRecommend() {
    EmitterUtil.subscribe(VHRoomEventType.CHAT_MSG_SET_RECOMMEND, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°è®¾ç½®ç²¾é€‰æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.CHAT_MSG_SET_RECOMMEND}`);
      let chatMsgSetRecommend: VHChatMsgSetRecommend = msgData.data as VHChatMsgSetRecommend;
      if (chatMsgSetRecommend!) {
        if (typeof chatMsgSetRecommend === 'string') {
          const parsedMessage: VHChatDeleteMsg = JSON.parse(chatMsgSetRecommend) as VHChatDeleteMsg;
        } else {
        }
      }
    });
  }

  subscribeChatMsgDelRecommend() {
    EmitterUtil.subscribe(VHRoomEventType.CHAT_MSG_DEL_RECOMMEND, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°å–æ¶ˆç²¾é€‰æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.CHAT_MSG_DEL_RECOMMEND}`);
      let chatMsgDelRecommend: VHChatMsgDelRecommend = msgData.data as VHChatMsgDelRecommend;
      if (chatMsgDelRecommend!) {
        if (typeof chatMsgDelRecommend === 'string') {
          const parsedMessage: VHChatMsgDelRecommend = JSON.parse(chatMsgDelRecommend) as VHChatMsgDelRecommend;
        } else {
        }
      }
    });
  }

  subLotteryMsg(){
    EmitterUtil.subscribe(MsgType.LOTTERY_MSG, (msgData: EmitterMsgData) => {
      let messageModel: string = msgData.data as string;
      // å‘é€æ¶ˆæ¯
      this.imBase.sendMessage(messageModel, {
        onSuccess: () => {
          console.log("æ¶ˆæ¯å‘é€æˆåŠŸ");
        },
        onFailure(errorCode: number, errorMsg: string) {
          // å¼¹å‡ºæ¶ˆæ¯ä¿¡æ¯
          ToastUtil.showToast("å‘é€æ¶ˆæ¯å¤±è´¥");
        }
      });
    });
  }

  subscribeGiftMessage() {
    EmitterUtil.subscribe(VHRoomEventType.GIFT_MSG, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°ç¤¼ç‰©ç±»å‹æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.GIFT_MSG}`);
      let giftInfo: VHGiftMessageInfo = msgData.data as VHGiftMessageInfo;
      if (giftInfo!) {
        if (typeof giftInfo === 'string') {
          const parsedMessage: VHGiftMessageInfo = JSON.parse(giftInfo) as VHGiftMessageInfo;
          this.handleGiftMessage(parsedMessage);
        } else {
          this.handleGiftMessage(giftInfo);
        }
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });
  }

  //è®¢é˜…ç¦è¨€äº‹ä»¶
  subscribeChatDisable() {
    EmitterUtil.subscribe(VHRoomEventType.CHAT_DISABLE, (msgData: EmitterMsgData) => {
      this.chatDisable = true;
    });
    EmitterUtil.subscribe(VHRoomEventType.CHAT_PERMIT, (msgData: EmitterMsgData) => {
      this.chatDisable = false;
    });
    EmitterUtil.subscribe(VHRoomEventType.CHAT_DISABLE_ALL, (msgData: EmitterMsgData) => {
      let chatDisableAllMsg: VHChatDisableAllMsg = msgData.data as VHChatDisableAllMsg;
      if (chatDisableAllMsg != null && chatDisableAllMsg.chat_status == 1) {
        this.chatDisable = true;
      }
    });
    EmitterUtil.subscribe(VHRoomEventType.CHAT_PERMIT_ALL, (msgData: EmitterMsgData) => {
      let chatDisableAllMsg: VHChatDisableAllMsg = msgData.data as VHChatDisableAllMsg;
      if (chatDisableAllMsg != null && chatDisableAllMsg.chat_status == 1) {
        this.chatDisable = false;
      }
    });
  }

  // è®¢é˜…é—®ç­”ä¿¡æ¯
  subscribeQuestionAnswerMessage() {
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_OPEN, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°é—®ç­”å¼€å¯ä¿¡æ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_OPEN}`);
      let questionAnswerInfo: VHQuestionAnswerSwitchMsg = msgData.data as VHQuestionAnswerSwitchMsg;
      if (questionAnswerInfo!) {
        if (typeof questionAnswerInfo === 'string') {
          const parsedMessage: VHQuestionAnswerSwitchMsg = JSON.parse(questionAnswerInfo) as VHQuestionAnswerSwitchMsg;
          this.handleQuestionAnswerMessage(parsedMessage);
        } else {
          this.handleQuestionAnswerMessage(questionAnswerInfo);
        }
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });

    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_CLOSE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°é—®ç­”å…³é—­ä¿¡æ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_CLOSE}`);
      let questionAnswerInfo: VHQuestionAnswerSwitchMsg = msgData.data as VHQuestionAnswerSwitchMsg;
      if (questionAnswerInfo!) {
        if (typeof questionAnswerInfo === 'string') {
          const parsedMessage: VHQuestionAnswerSwitchMsg = JSON.parse(questionAnswerInfo) as VHQuestionAnswerSwitchMsg;
          this.handleQuestionAnswerMessage(parsedMessage);
        } else {
          this.handleQuestionAnswerMessage(questionAnswerInfo);
        }
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });
  }

  handleTextMessage(msg?: VHIMMessageModel) {
    if (!msg) {
      return;
    }
    // æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
    let imMsg: VHContent = msg as VHContent;
    imMsg.nickname = msg.nick_name;
    imMsg.date_time = this.formatTime(msg.date_time!);
    imMsg.data = msg.data as VHMsgData;
    let context = JSON.parse(msg.context as string) as VHContext;
    imMsg.role_name = context.role_name === '1' ? 'ä¸»æŒäºº' : '';
    if (context?.replyMsg !== undefined) {
      // å›å¤æ¶ˆæ¯
      let replyMessage = context?.replyMsg as VHReplyMessage;
      if (replyMessage != null && replyMessage.content !== undefined) {
        let replyContent = replyMessage.content as VHReplyMessageContent;
        if (replyContent !== null && replyContent.type === VHRoomEventType.IM_TYPE_TEXT) {
          let msgData = imMsg.data as VHMsgData;
          let replyContentStr = replyMessage.nickname  +"ï¼š "+replyContent.text_content + "\n\n" + "å›å¤ï¼š " + imMsg.data?.text_content;
          imMsg.data =
            new VHMsgData(msgData.type, replyContentStr, replyContentStr, msgData.nickname, msgData.avatar, []);
        }
      }
    }
    this.historyData.push(imMsg);
  }

  handleLikeCount(msg?: VHIMMessageModel) {
    if (!msg) {
      return;
    }
    // æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
    let imMsg: VHContent = msg as VHContent;
    imMsg.data = msg.data as VHMsgData;
    // æ¥æ”¶ç‚¹èµæ•°
    if (imMsg.data!.event_type === VHRoomEventType.CUSTOM_PRAISE && imMsg.data!.num! > 0) {
      this.likeCount = imMsg.data.num;
    }
  }

  handleChatDeleteMsg(chatDeleteMsg: VHChatDeleteMsg) {
    if (!chatDeleteMsg) {
      return;
    }
    // let msgIds: string[] = chatDeleteMsg.msg_ids.split(",");
    if (chatDeleteMsg.msg_ids.length > 0) {
      this.historyData = this.historyData.filter(item => !chatDeleteMsg.msg_ids.includes(item.msg_id));
    }
  }

  handleGiftMessage(giftInfo: VHGiftMessageInfo) {
    if (!giftInfo) {
      return;
    }
    // å°†æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨ï¼ˆæ›´æ–°UIï¼‰
    let msgContent =
      ChatTools.getLimitString(giftInfo.gift_user_nickname, 8) + " " + "é€å‡º" + " " + giftInfo.gift_name;
    let image_urls: string[] = [];
    image_urls.push(giftInfo.gift_image_url);
    let msgData: VHMsgData = new VHMsgData(VHRoomEventType.GIFT_MSG, msgContent, msgContent, '', '', image_urls);
    let imMsg: VHContent = new VHContent("", "", msgData, '', undefined);
    this.historyData.push(imMsg);
  }

  handleQuestionAnswerMessage(questionAnswerInfo: VHQuestionAnswerSwitchMsg) {
    if (!questionAnswerInfo) {
      return;
    }
    // å°†æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨ï¼ˆæ›´æ–°UIï¼‰role_name: 1 ä¸»æŒäººï¼Œ2 è§‚ä¼—ï¼Œ3 åŠ©ç†ï¼Œ4 å˜‰å®¾
    let roleName = questionAnswerInfo.role_name === '1' ? 'ä¸»æŒäºº' : '';
    let eventType = questionAnswerInfo.event_type === VHRoomEventType.QUESTION_ANSWER_OPEN ? 'å¼€å¯' : 'å…³é—­';
    let msgContent = roleName + " " +
    ChatTools.getLimitString(questionAnswerInfo.nick_name, 8) + " " + eventType + "äº†é—®ç­” ";
    let msgData: VHMsgData = new VHMsgData(VHRoomEventType.GIFT_MSG, msgContent, msgContent, '', '', []);
    let imMsg: VHContent = new VHContent("", "", msgData, '', undefined);
    this.historyData.push(imMsg);
  }

  //åˆå§‹åŒ–
  initChatMessage(pageNo: number) {
    try {
      VHSaaSDK.getInstance()
        .chatGetList(this.webinars?.interact?.room_id!, pageNo, this.pageSize, '', '', '', 0, 0, '', {
          onSucceed: (data: VHChatMessageList) => {
            this.total = data.total;
            this.pageNo = pageNo;
            this.hasMoreData = this.pageNo * this.pageSize < this.total;
            if (pageNo === 1) {
              this.historyData = [];
            }
            if (this.hasMoreData) {
              //è®¾ç½®ç»„ä»¶ä¸ºåˆå§‹çŠ¶æ€
              this.reachStatus = 0
            } else {
              //åˆ°åº•äº†
              this.reachStatus = 2
            }
            this.changeChatMessage(data);
            setTimeout(() => {
              this.scrollToBottom();
            }, 100);
          },
          onFailure: (errorCode, errorMsg) => {
            console.log("èŠå¤©è·å¾—å†å²è®°å½•å¤±è´¥ï¼š", errorMsg)
            ToastUtil.showToast(errorMsg);
          }
        });
    } catch (e) {
      console.log("èŠå¤©è·å¾—å†å²è®°å½•å¤±è´¥ï¼š", e)
    } finally {
      this.isRefreshing = false
      this.isLoadingMore = false
      this.initCompleted = true
    }
  }

  // åˆ·æ–°å¤„ç†
  private handleRefresh() {
    if (!this.isRefreshing) {
      this.isRefreshing = true
      this.reachStatus = 0
      this.initChatMessage(1);
    }
  }

  //è§¦åº•åŠ è½½æ›´å¤šæ•°æ®
  handleLoadingMore() {
    //é˜²æ­¢å¤šæ¬¡è¯·æ±‚ï¼Œè§¦åº•è¯·æ±‚å®Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡ï¼ŒèŠ‚æµ
    if (this.isLoadingMore) {
      return
    }
    this.isLoadingMore = true
    //è®¾ç½®ç»„ä»¶å¤„äºåŠ è½½çŠ¶æ€
    this.reachStatus = 1
    let pageNo = this.pageNo + 1
    this.initChatMessage(pageNo)

    // æ›´æ–°æœ€åæ»šåŠ¨ä½ç½®
    setTimeout(() => {
      const currentOffset = this.scroller.currentOffset()
      this.lastScrollOffset = currentOffset.yOffset
    }, 100)
  }

  getLikeCount() {
    VHSaaSDK.getInstance().getRoomLike(this.webinars?.interact?.room_id!, {
      onSucceed: (data: VHRoomLikeInfo) => {
        this.likeCount = Number(data.total) + Number(data.virtual_count) ;
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("èŠå¤©è·å¾—å†å²è®°å½•å¤±è´¥ï¼š", errorMsg)
      }
    });
  }

  userLike() {
    VHSaaSDK.getInstance().userLike(this.webinars?.interact?.room_id!, this.clickLikeNumber.toString(), {
      onSuccess: (data: string | object) => {
        console.log("å¢åŠ ç‚¹èµæ•°ï¼š", this.clickLikeNumber);
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("å¢åŠ ç‚¹èµæ•°å¤±è´¥ï¼š", errorMsg)
      }
    });
  }

  changeChatMessage(data: VHChatMessageList) {
    // è½¬æ¢æ¨¡å‹
    let newData: VHContent[] = [];
    let array = data?.list;
    if (Array.isArray(array) && array.length > 0) {
      array.reverse();
      array.forEach((obj: object) => {
        let contact = obj as VHContent;
        contact.msg_id = obj['msg_id'];
        contact.date_time = this.formatTime(obj['date_time']);
        contact.role_name = obj['context']?.role_name === 1 ? 'ä¸»æŒäºº' : '';
        if (obj['data']?.text_content.indexOf(VHRoomEventType.GIFT_MSG) > 0) {
          // å¤„ç†ç¤¼ç‰©æ•°æ®
          if (obj['data']?.text_content.length > 0) {
            let giftMsg = JSON.parse(obj['data']?.text_content as string) as VHGiftMessageInfo;
            let msgContent =
              ChatTools.getLimitString(giftMsg.gift_user_nickname, 8) + " " + "é€å‡º" + " " + giftMsg.gift_name;
            let image_urls: string[] = [];
            image_urls.push(giftMsg.gift_image_url);
            let msgData: VHMsgData =
              new VHMsgData(VHRoomEventType.GIFT_MSG, msgContent, msgContent, '', '', image_urls);
            contact.data = msgData;
            contact.date_time = '';
          }
        }
        if (obj['context']?.reply_msg !== undefined) {
          let replyMessage = obj['context']?.reply_msg as VHReplyMessage;
          if (replyMessage != null && replyMessage.content !== undefined) {
            let replyContent = replyMessage.content as VHReplyMessageContent;
            if (replyContent !== null && replyContent.type === VHRoomEventType.IM_TYPE_TEXT) {
              let msgData = contact.data as VHMsgData;
              let replyContentStr =
                replyMessage.nick_name + "ï¼š " + replyContent.text_content + "\n \n" + "å›å¤ï¼š " + contact.data?.text_content;
              contact.data =
                new VHMsgData(msgData.type, replyContentStr, replyContentStr, msgData.nickname, msgData.avatar, []);
            }
          }
        }
        if (contact.data!.type === VHRoomEventType.IM_TYPE_TEXT && contact.data!.text_content.length === 0) {
          return;
        }
        newData.push(contact);
      });
      if (newData.length > 0) {
        // æ‰¹é‡æ›´æ–°æ•°æ®
        if (this.pageNo === 1) {
          this.historyData = newData;
        } else {
          this.historyData = [...newData, ...this.historyData];
        }
      }
    }
  }


  formatTime(dateTime: string): string {
    return dateTime.substring(dateTime.lastIndexOf(" "));
  }

  /**
   * æ»šåŠ¨æ¶ˆæ¯åˆ—è¡¨åˆ°æœ€åº•éƒ¨ï¼Œä»¥å¤‡æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯ã€‚
   */
  scrollToBottom() {
    this.scroller.scrollEdge(Edge.Bottom);
  }

  setKeyboardAvoidModeToRESIZE(context: UIContext, toRESIZE: boolean) {
    context.setKeyboardAvoidMode(toRESIZE ? KeyboardAvoidMode.RESIZE : KeyboardAvoidMode.OFFSET);
  }

  /**
   * æ”¶åˆ°é”®ç›˜
   * @param context
   */
  hideSoftInputMethod(context: UIContext) {
    context.getFocusController().clearFocus();
  }

  // åˆå§‹åŒ–å€’è®¡æ—¶å™¨ï¼ˆæ€»æ—¶é—´2ç§’ï¼Œé—´éš”1ç§’ï¼‰
  initTimer() {
    this.timer = new CountDownTimer(2000, 1000)
    // å€’è®¡æ—¶ä¸­å›è°ƒï¼šæ›´æ–°UIå±•ç¤ºå‰©ä½™æ—¶é—´
      .onTick((remainingTime) => {
        const seconds = Math.ceil(remainingTime / 1000);
      })
      // å€’è®¡æ—¶ç»“æŸå›è°ƒï¼šæ›´æ–°ç»“æŸçŠ¶æ€
      .onFinish(() => {
        this.userLike();
        this.clickLikeNumber = 0;
      });
  }

  // åˆ›å»ºä¸€ä¸ªå›¾æ ‡å¯¹è±¡
  createIcon(x: number, y: number, radius: number, emoji: string): VHLikeIcon {
    // ä¸ºå›¾æ ‡ç”Ÿæˆéšæœºå±æ€§
    const initialScale = 0.4 + Math.random() * 0.2 // åˆå§‹ç¼©æ”¾æ¯”ä¾‹0.4-0.6
    const maxScale = 1.0 + Math.random() * 0.3 // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹1.0-1.3
    // å‡å°æ‘†åŠ¨å¹…åº¦ï¼Œæ”¹ä¸ºæœ€å¤§8-15åƒç´ 
    const maxOffset = 8 + Math.random() * 7 // æœ€å¤§æ‘†åŠ¨å¹…åº¦8-15åƒç´ 
    // éšæœºå†³å®šåˆå§‹æ‘†åŠ¨æ–¹å‘
    const direction = Math.random() > 0.5 ? 1 : -1

    return {
      x: x,
      y: y,
      initialX: x, // è®°å½•åˆå§‹Xåæ ‡
      initialY: y, // è®°å½•åˆå§‹Yåæ ‡
      radius: radius,
      emoji: emoji,
      fontSize: Math.floor(radius * 1.2),
      opacity: 1.0,
      createTime: Date.now(),
      lifespan: 1500, // å»¶é•¿ç”Ÿå‘½å‘¨æœŸè‡³1.5ç§’
      scale: initialScale, // å½“å‰ç¼©æ”¾æ¯”ä¾‹
      initialScale: initialScale, // åˆå§‹ç¼©æ”¾æ¯”ä¾‹
      maxScale: maxScale, // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
      maxOffset: maxOffset, // æœ€å¤§æ‘†åŠ¨å¹…åº¦
      direction: direction // åˆå§‹æ‘†åŠ¨æ–¹å‘
    }
  }

  // è·å–éšæœºemoji
  getRandomEmoji(): string {
    return this.emojis[Math.floor(Math.random() * this.emojis.length)]
  }

  // æ·»åŠ æ–°çš„ç‚¹èµå›¾æ ‡
  addLikeIcon(baseX: number, baseY: number) {
    const radius = 80 + Math.random() * 20
    const emoji = this.getRandomEmoji()
    // æ·»åŠ éšæœºä½ç½®åç§»ï¼ˆÂ±15pxèŒƒå›´å†…ï¼‰
    const offsetX = Math.random() * 30 - 15
    const offsetY = Math.random() * 30 - 15
    this.likeIcons.push(this.createIcon(baseX + offsetX, baseY + offsetY, radius, emoji))
  }

  // å¼€å§‹åŠ¨ç”»å¾ªç¯
  startAnimation() {
    this.animationId = setInterval(() => {
      this.updateIcons()
      this.drawAllIcons()
    }, 16) // çº¦60fpsçš„åˆ·æ–°ç‡
  }

  // æ›´æ–°æ‰€æœ‰å›¾æ ‡çŠ¶æ€
  updateIcons() {
    const currentTime = Date.now()
    const newIcons: VHLikeIcon[] = []

    for (let icon of this.likeIcons) {
      // è®¡ç®—å›¾æ ‡å·²å­˜åœ¨çš„æ—¶é—´
      const existTime = currentTime - icon.createTime

      if (existTime < icon.lifespan) {
        // è®¡ç®—å­˜åœ¨æ—¶é—´æ¯”ä¾‹
        const progress = existTime / icon.lifespan

        // 1. æ›´æ–°Yåæ ‡ - å‘ä¸Šç§»åŠ¨ï¼Œé€Ÿåº¦å˜åŒ–æ›´æ˜æ˜¾
        const verticalDistance = 200 * Math.pow(progress, 0.5) // å‡ç¼“ä¸Šå‡é€Ÿåº¦ // ä½¿ç”¨å¹‚å‡½æ•°è®©ä¸Šå‡æ›´å¿«
        icon.y = icon.initialY - verticalDistance

        // 2. æ›´æ–°Xåæ ‡ - å¿«é€Ÿçš„å·¦å³æ‘†åŠ¨
        // æ¯0.25ç§’ä¸€ä¸ªé˜¶æ®µï¼Œæ€»å…±1ç§’4ä¸ªé˜¶æ®µ
        let horizontalOffset = 0;

        if (progress < 0.25) {
          // 0-0.25s: æ— åç§»ï¼Œä¸“æ³¨äºæ”¾å¤§
          horizontalOffset = 0;
        } else if (progress < 0.5) {
          // 0.25-0.5s: å‘å·¦åç§»
          const phaseProgress = (progress - 0.25) / 0.25;
          horizontalOffset = -icon.maxOffset * phaseProgress * icon.direction;
        } else if (progress < 0.75) {
          // 0.5-0.75s: ä»å‘å·¦åç§»å˜ä¸ºå‘å³åç§»
          const phaseProgress = (progress - 0.5) / 0.25;
          horizontalOffset = icon.maxOffset * (2 * phaseProgress - 1) * icon.direction;
        } else {
          // 0.75-1s: ä»å‘å³åç§»å›åˆ°å‘å·¦åç§»
          const phaseProgress = (progress - 0.75) / 0.25;
          horizontalOffset = icon.maxOffset * (1 - 2 * phaseProgress) * icon.direction;
        }

        icon.x = icon.initialX + horizontalOffset;

        // 3. æ›´æ–°ç¼©æ”¾æ¯”ä¾‹ - å¿«é€Ÿæ”¾å¤§
        // åœ¨ç”Ÿå‘½å‘¨æœŸçš„å‰20%é˜¶æ®µ(0.2s)ï¼Œç¼©æ”¾ä»initialScaleå¢å¤§åˆ°maxScale
        if (progress < 0.2) {
          // å¹³æ»‘æ’å€¼ä»initialScaleåˆ°maxScale
          icon.scale = icon.initialScale + (icon.maxScale - icon.initialScale) * (progress / 0.2)
        } else {
          // ä¿æŒmaxScale
          icon.scale = icon.maxScale
        }

        // 4. æ›´æ–°é€æ˜åº¦ - å‰60%ä¿æŒä¸å˜ï¼Œå40%é€æ¸æ¶ˆå¤±
        if (progress > 0.6) {
          // åœ¨æœ€å40%çš„ç”Ÿå‘½å‘¨æœŸå†…æ”¹å˜é€æ˜åº¦ï¼Œä½¿æ¶ˆå¤±æ›´å¿«
          icon.opacity = 1.0 - ((progress - 0.6) / 0.4)
        } else {
          icon.opacity = 1.0
        }

        // ä¿ç•™æœªå®Œæˆç”Ÿå‘½å‘¨æœŸçš„å›¾æ ‡
        newIcons.push(icon)
      }
    }

    // æ›´æ–°å›¾æ ‡æ•°ç»„
    this.likeIcons = newIcons
  }

  // ç»˜åˆ¶æ‰€æœ‰å›¾æ ‡
  drawAllIcons() {
    // æ¸…é™¤ç”»å¸ƒ
    this.context.clearRect(0, 0, this.context.width, this.context.height)

    // ç»˜åˆ¶æ‰€æœ‰å›¾æ ‡
    for (let icon of this.likeIcons) {
      this.context.save()

      // è®¾ç½®é€æ˜åº¦
      this.context.globalAlpha = icon.opacity

      // è®¾ç½®ç¼©æ”¾ï¼ˆä»ä¸­å¿ƒç‚¹ç¼©æ”¾ï¼‰
      this.context.translate(icon.x, icon.y)
      this.context.scale(icon.scale, icon.scale)
      this.context.translate(-icon.x, -icon.y)

      // ç»˜åˆ¶emoji
      this.context.font = `${icon.fontSize}px`
      this.context.textAlign = 'center'
      this.context.textBaseline = 'middle'
      this.context.fillText(icon.emoji, icon.x, icon.y)

      this.context.restore()
    }
  }

  // ç‚¹å‡»åˆ—è¡¨å›¾ç‰‡ï¼šæ‰“å¼€é¢„è§ˆ
  openImagePreview(url: string) {
    this.currentPreviewUrl = url;
    this.isPreviewShow = true;
  }

  // ç‚¹å‡»èŠå¤©åˆ—è¡¨ï¼šå…³é—­é¢„è§ˆ
  closeImagePreview() {
    this.isPreviewShow = false;
  }

  private async selectImage() {
    // 1. æ‰“å¼€ç›¸å†Œé€‰æ‹©å›¾ç‰‡
    try {
      // 1. æ‰“å¼€ç›¸å†Œé€‰æ‹©å›¾ç‰‡ï¼ˆå¼‚æ­¥ï¼‰
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;
      const photoPicker = new picker.PhotoViewPicker();
      const res: picker.PhotoSelectResult = await photoPicker.select(photoSelectOptions); // ä½¿ç”¨ await ç­‰å¾…ç»“æœ
      let bufferStr: string = '';
      if (res && res.photoUris && res.photoUris.length > 0) {
        // è¯»å–å›¾ç‰‡
        const uri = res.photoUris[0];
        const file = fs.openSync(uri)
        const stat = fs.statSync(file.fd)
        const buffer = new ArrayBuffer(stat.size)
        fs.readSync(file.fd, buffer)
        fs.closeSync(file)
        // 3. è½¬æˆbase64ç¼–ç çš„å­—ç¬¦ä¸²
        const helper = new util.Base64Helper()
        bufferStr = helper.encodeToStringSync(new Uint8Array(buffer));
        bufferStr = "data:image/png;base64," + bufferStr;
        if (bufferStr.length > 0) {
          this.uploadToServer(bufferStr);
        }
      }
    } catch (error) {
      console.error("å›¾ç‰‡é€‰æ‹©å¤±è´¥:", error);
      ToastUtil.showToast("å›¾ç‰‡é€‰æ‹©å¤±è´¥!");
    }
  }

  // ä¸Šä¼ äºŒè¿›åˆ¶æµ
  uploadToServer(bufferStr: string) {
    VHSaaSDK.getInstance().uploadImage(bufferStr, {
      onSucceed: (data: VHUploadFileInfo) => {
        let domain_url: string = data.domain_url
        if (domain_url.length > 0) {
          let image_urls: string[] = [];
          image_urls.push(domain_url);
          let imageInfoStr = JSON.stringify(image_urls);
          // å‘é€å›¾ç‰‡æ¶ˆæ¯
          this.imBase.sendTypeMessage(imageInfoStr,'', 1, {
            onSuccess: () => {
              console.log("å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ!");
              setTimeout(() => {
                this.scrollToBottom();
              }, 100);
            },
            onFailure(errorCode: number, errorMsg: string) {
              console.error("å›¾ç‰‡æ¶ˆæ¯å‘é€å¤±è´¥ï¼š", errorMsg);
              ToastUtil.showToast("å›¾ç‰‡å‘é€å¤±è´¥!");
            }
          });
        }
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("ä¸Šä¼ å›¾ç‰‡äºŒè¿›åˆ¶æµå¤±è´¥ï¼š", errorMsg);
        ToastUtil.showToast("å›¾ç‰‡å‘é€å¤±è´¥:" + errorMsg);
      }
    });
  }

  /**
   * é«˜äº®æ˜¾ç¤ºæ–‡æœ¬ä¸­çš„å…³é”®å­—ã€‚
   *
   * @param fullText å®Œæ•´æ–‡æœ¬
   * @param keyword è¦é«˜äº®çš„å…³é”®å­—
   * @param keywordColor å…³é”®å­—é¢œè‰²ï¼Œé»˜è®¤çº¢è‰²
   * @param normalColor æ™®é€šæ–‡æœ¬é¢œè‰²ï¼Œé»˜è®¤é»‘è‰²
   */
  // @Builder
  // getHighlightedText(
  //   segments: Array<{ text: string; isKeyword: boolean }>,
  //   keywordColor: ResourceColor = Color.Red,
  //   normalColor: ResourceColor = Color.Black
  // ) {
  //   Text() {
  //     ForEach(segments, (segment) => {
  //       Span(segment.text)
  //         .fontColor(segment.isKeyword ? keywordColor : normalColor);
  //     });
  //   }
  // }

  build() {
    // Navigation(this.pageInfos) {
    Column() {
      Stack() {
        // èŠå¤©ç•Œé¢å†…å®¹åŒº
        Column() {
          List({ space: 4, scroller: this.scroller }) {
            ForEach(this.historyData, (item: VHContent, index) => {
              ListItem() {
                Row({ space: 8 }) {
                  Image((item.avatar === '' && item.data!.type !== VHRoomEventType.GIFT_MSG) ?
                  $r("app.media.icon_visitorvatar") : item.avatar)
                    .width(30)
                    .height(30)
                    .borderRadius(20)
                  Column() {
                    Row() {
                      Text(this.chatNickNameEnc == 0 ? ChatTools.getLimitString(item.nickname!, 8) : ChatTools.getLimitString(item.nickname!, 2) )
                        .fontColor(Color.Gray).fontSize(12).padding({ right: 10 })
                      Text(item.role_name!)
                        .fontColor(Color.Red)
                        .fontSize(12)
                        .borderRadius(8)
                        .backgroundColor(item.role_name.length > 0 ? '#FFE6F2' : "#FAFAFA")
                        .padding({
                          top: 2,
                          left: 4,
                          right: 4,
                          bottom: 2
                        })
                      if (item.date_time!.length > 0) {
                        Text(item.date_time)
                          .fontColor(Color.Gray)
                          .fontSize(12)
                          .layoutWeight(1)
                          .padding({ right: 10 })
                          .textAlign(TextAlign.End)
                      }
                    }
                    if (item.data!.type !== VHRoomEventType.IM_IMAGE)
                    Column() {
                      Row(){
                        Text(EmojiTool.convertEmojiTags(item.data?.text_content!))
                          .fontSize(12)
                          .padding({
                            top: 6,
                            bottom: 6,
                            left: 10,
                            right: 10
                          })
                          .borderRadius(8)
                          .backgroundColor(item.data?.type === VHRoomEventType.GIFT_MSG ? '#fffff0f2' : Color.White)
                        if (item.data?.type === VHRoomEventType.GIFT_MSG)
                        Column() {
                          ForEach(item.data!.image_urls, (url: string) => {
                            Image(url)
                              .width(30)
                              .height(26)
                              .margin({ left: -5 })
                              .borderRadius(8)
                              .interpolation(ImageInterpolation.High)
                              .syncLoad(true)
                              .backgroundColor('#fffff0f2')
                          })
                        }
                      }
                      .width('100%')
                      .justifyContent(item.data?.type === VHRoomEventType.GIFT_MSG ? FlexAlign.Center : FlexAlign.Start)
                    }
                    .width('98%')

                    if (item.data!.type === VHRoomEventType.IM_IMAGE && item.data!.image_urls != null)
                    Row() {
                      ForEach(item.data!.image_urls, (url: string) => {
                        Image(url)
                          .width(40)
                          .height(40)
                          .margin(2)
                          .borderRadius(8)
                          .interpolation(ImageInterpolation.High)
                          .syncLoad(true)
                          .onClick(() => {
                            // å›¾ç‰‡é¢„è§ˆ
                            this.openImagePreview(url!);
                          })
                      })
                    }

                    if (this.isPreviewShow) {
                      Stack() {
                        Column() {
                          // é¢„è§ˆå›¾ç‰‡ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼Œé™åˆ¶æœ€å¤§å®½é«˜ï¼‰
                          Image(this.currentPreviewUrl)
                            .width(300)
                            .height(300)
                            .objectFit(ImageFit.Fill)
                        }
                        .zIndex(105)
                        .width('100%')
                        .height('100%')
                        .padding({ left: -20 })
                        .position({ x: 0, y: 0 }) // å…¨å±è¦†ç›–åœ¨åˆ—è¡¨ä¸Šæ–¹
                        .justifyContent(FlexAlign.Center)
                        .alignItems(HorizontalAlign.Center)
                      }
                    }

                  }
                  .width('98%')
                  .padding({right:12})
                  .borderRadius(8)
                  .alignItems(item.data?.type === VHRoomEventType.GIFT_MSG ? HorizontalAlign.Center : HorizontalAlign.Start)
                }
                .width('98%')
                .padding(8)
                .borderRadius(8)
                .justifyContent(FlexAlign.Start)
                .alignItems(VerticalAlign.Top)
              }
            })

            ForEach(this.examRankMsg,(item:VHExamRank,index)=>{
              ListItem() {
                Column() {
                  Blank()
                    .layoutWeight(1)
                  Row() {
                    Text(item.role_name == "1" ? 'ä¸»æŒäºº' : '')
                      .fontSize(12)
                      .fontColor('#f40')
                      .backgroundColor('#ffffcaca')
                      .borderRadius('50%')
                      .padding({ left: 6, right: 6 })
                      .margin({ right: 4 })
                    Text('å…¬å¸ƒäº†')
                      .fontSize(12)
                      .fontColor('#666')
                    Text(' æˆç»©æ’è¡Œæ¦œ ')
                      .fontSize(12)
                      .fontColor('#ff503ea0')
                      .onClick(() => {
                        PromptActionClass.closeDialog()
                        // åˆ›å»ºå‚æ•°å¯¹è±¡
                        const params = new reportParams(item, this.webinars!);
                        this.examReportContentNode = new ComponentContent(this.getUIContext(), wrapBuilder(createExamReportView), params);
                        PromptActionClass.setContext(this.getUIContext());
                        PromptActionClass.setContentNode(this.examReportContentNode);
                        PromptActionClass.openDialog();

                      })
                    Text("ã€Š" + item.paper_title + "ã€‹")
                      .fontSize(12)
                      .fontColor('#666')
                  }
                  .height(20)
                  .padding({
                    left: 12,
                    right: 12
                  })
                  .backgroundColor('#e8ffe7e7')
                  .borderRadius('50%')
                  .justifyContent(FlexAlign.Center)

                  Blank()
                    .layoutWeight(1)
                }
                .width('100%')
                .height(20)
              }
            })



            LoadingMoreView({ visible: this.loadingMoreVisible, status: this.reachStatus, isShowTip: false })
            if (this.questionnairePush != null) {
              ListItem() {
                Column() {
                  Blank()
                    .layoutWeight(1)
                  Row() {
                    Text('ä¸»æŒäºº')
                      .fontSize(12)
                      .fontColor('#f40')
                      .backgroundColor('#ffffcaca')
                      .borderRadius('50%')
                      .padding({ left: 6, right: 6 })
                      .margin({ right: 4 })
                    Text('æ¨é€äº†é—®å·  ')
                      .fontSize(12)
                      .fontColor('#666')
                    Text('ç‚¹å‡»æŸ¥çœ‹')
                      .fontSize(12)
                      .fontColor('#ff503ea0')
                      .onClick(() => {
                        // this.pageInfos.pushPath({ name: 'QuestionnairePage' }, true);
                        this.VHQuestionnaireDialog.open()
                      })
                  }
                  .height(20)
                  .padding({
                    left: 12,
                    right: 12
                  })
                  .backgroundColor('#e8ffe7e7')
                  .borderRadius('50%')
                  .justifyContent(FlexAlign.Center)

                  Blank()
                    .layoutWeight(1)
                }
                .width('100%')
                .height(20)
              }
            }
            if (this.examData != null) {
              ListItem() {
                Column() {
                  Blank()
                    .layoutWeight(1)
                  Row() {
                    Text('ä¸»æŒäºº')
                      .fontSize(12)
                      .fontColor('#f40')
                      .backgroundColor('#ffffcaca')
                      .borderRadius('50%')
                      .padding({ left: 6, right: 6 })
                      .margin({ right: 4 })
                    Text('æ¨é€äº†å¿«é—®å¿«ç­”  ')
                      .fontSize(12)
                      .fontColor('#666')
                    Text('ç‚¹å‡»æŸ¥çœ‹')
                      .fontSize(12)
                      .fontColor('#ff503ea0')
                      .onClick(() => {
                        // this.pageInfos.pushPath({ name: 'ExamPage' }, true);
                        VHSaaSDK.getInstance()
                          .performExamIn(this.webinars?.webinar?.id!, 1,
                            this.webinars?.switch_info?.switch_id!, 0, {
                              onSucceed: (data) => {
                                this.ExamList = data
                                this.VHExamDialog.open()
                                console.log(`è·å–å¿«é—®å¿«ç­”åˆ—è¡¨æˆåŠŸï¼š ${JSON.stringify(data)}`);
                              },
                              onFailure: (errorCode, errorMsg) => {
                                console.log(`è·å–å¿«é—®å¿«ç­”åˆ—è¡¨å¤±è´¥ï¼š ${errorMsg}`);
                              }
                            })
                        // ToastUtil.showToast('å¿«é—®å¿«ç­”å·²æ‰“å¼€');
                      })
                  }
                  .height(20)
                  .padding({
                    left: 12,
                    right: 12
                  })
                  .backgroundColor('#e8ffe7e7')
                  .borderRadius('50%')
                  .justifyContent(FlexAlign.Center)

                  Blank()
                    .layoutWeight(1)
                }
                .width('100%')
                .height(20)
              }
            }
          }
          .width('100%')
          .height('80%')
          .cachedCount(3)
          // ç›‘å¬ç»„ä»¶è§¦å±äº‹ä»¶ï¼Œç¡®ä¿è§¦ç¢°èŠå¤©åˆ—è¡¨æ—¶ï¼Œèƒ½è‡ªåŠ¨æ”¶èµ·è¾“å…¥æ³•è½¯é”®ç›˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
          .onTouch((event: TouchEvent) => {
            // æ”¶èµ·è½¯é”®ç›˜
            this.hideSoftInputMethod(this.getUIContext());
            // ç‚¹å‡»åˆ—è¡¨å…³é—­é¢„è§ˆ
            this.closeImagePreview();
          })
          // ç›‘å¬ç»„ä»¶å¤§å°å˜åŒ–äº‹ä»¶ï¼ˆç”¨äºå®ç°å½“è½¯é”®ç›˜æ˜¾ç¤ºæ—¶ï¼Œåˆ—è¡¨é«˜åº¦è¢«å‹ç¼©åï¼Œæ¶ˆæ¯ä¸èƒ½è‡ªåŠ¨æ˜¾ç¤ºæœ€åä¸€æ¡çš„é—®é¢˜ï¼‰
          .onSizeChange((oldValue: SizeOptions, newValue: SizeOptions) => {
            let oldHeight = oldValue.height, newHeight = newValue.height;
            oldHeight = (oldHeight === undefined ? 0 : oldHeight);
            newHeight = (newHeight === undefined ? 0 : newHeight);
            // åˆ—è¡¨é«˜åº¦å˜å°ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯è½¯é”®ç›˜æ˜¾ç¤ºäº†
            let toBeSmall = (newHeight > 0 && newHeight < oldHeight);
            if (toBeSmall) {
              // æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æœ€æ–°ä¸€æ¡æ¶ˆæ¯è¢«æ˜¾ç¤º
              this.scrollToBottom();
            }
          })
          .scrollBar(BarState.Off)
          .edgeEffect(EdgeEffect.Spring)
          .width("100%")
          .height('100%')
          .layoutWeight(1)
          .listDirection(Axis.Vertical)
          .zIndex(100) // ä¿æŒæœ€é«˜å±‚çº§
          .onReachEnd(() => {
            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (this.isHandlingReachEnd) {
              return
            }
            // åªæœ‰åœ¨ç”¨æˆ·ä¸»åŠ¨æ»šåŠ¨ä¸”æ»¡è¶³æ¡ä»¶æ—¶æ‰è§¦å‘åŠ è½½æ›´å¤š
            if (this.initCompleted && this.reachStatus !== 2) {
              // è·å–å½“å‰æ»šåŠ¨ä½ç½®åˆ¤æ–­æ˜¯å¦ä¸ºçœŸå®è§¦åº•
              const currentOffset = this.scroller.currentOffset()
              const isRealScroll = currentOffset.yOffset > this.lastScrollOffset && this.lastScrollOffset > 0

              if (isRealScroll || currentOffset.yOffset > this.lastScrollOffset) {
                this.isHandlingReachEnd = true
                this.loadingMoreVisible = true
                this.handleLoadingMore()

                // åœ¨åŠ è½½å®Œæˆåé‡ç½®æ ‡å¿—
                setTimeout(() => {
                  this.isHandlingReachEnd = false
                }, 300)
              }
              this.lastScrollOffset = currentOffset.yOffset
            }
          })

          Canvas(this.context)
            .width('100%')
            .height('80%')  // è¿›ä¸€æ­¥å‡å°‘é«˜åº¦
            .position({ x: 0, y: 0 })
            // .position({ type: 'absolute' })
            .zIndex(0)
            .backgroundColor(Color.Transparent)
            .onReady(() => {
              console.info(`Canvas size: ${this.context.width} x ${this.context.height}`)
            })

          // åº•éƒ¨æ¶ˆæ¯è¾“å…¥åŒº
          Row() {
            Image(this.avatar)
              .width(30)
              .height(30)
              .borderRadius(20)

            TextInput({
              placeholder: this.chatDisable ? "æ‚¨å·²è¢«ç¦è¨€" : "å‚ä¸èŠå¤©", text: $$this.messageInput
            })
              .width('75%')
              .height(34)
              .backgroundColor('#EEEEEE')
              .fontSize(15)
              .layoutWeight(1)
              .borderRadius(8)
              .margin({ left: 5, right: 5 })
              .placeholderFont({ size: 14 })
              .placeholderColor('#a1a7af')
              .enabled(!this.chatDisable)
              .onChange((msg: string) => {
                this.messageInput = msg
              })

            Button("æäº¤", { type: ButtonType.Normal, stateEffect: true })
              .width(44)
              .height(34)
              .borderRadius(8)
              .padding(0)
              .fontSize(14)
              .backgroundColor('#00de7a')
              .fontWeight(500)
              .enabled(!this.chatDisable)
              .onClick(() => {
                if (this.chatDisable) {
                  ToastUtil.showToast("æ‚¨å·²è¢«ç¦è¨€");
                  return
                }

                if (this.messageInput === '') {
                  ToastUtil.showToast("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹");
                  return
                }

                // å‘é€æ¶ˆæ¯
                this.imBase.sendMessage(this.messageInput, {
                  onSuccess: () => {
                    console.log("æ¶ˆæ¯å‘é€æˆåŠŸ");
                    this.messageInput = '';
                    // æ”¶èµ·è½¯é”®ç›˜
                    this.hideSoftInputMethod(this.getUIContext());
                    // 5. å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
                    setTimeout(() => {
                      this.scrollToBottom();
                    }, 100);
                  },
                  onFailure(errorCode: number, errorMsg: string) {
                    // å¼¹å‡ºæ¶ˆæ¯ä¿¡æ¯
                    ToastUtil.showToast("å‘é€æ¶ˆæ¯å¤±è´¥");
                  }
                });
              });
            // ä¸Šä¼ å›¾ç‰‡
            Image($r('app.media.upload'))
              .width(35)
              .height(35)
              .margin({ left: 5, right: 5 })
              .onClick(() => {
                this.selectImage()
              })
            if (this.functionConfig?.hide_gifts == 0) {
              Image($r('app.media.icon_gift'))
                .width(30)
                .height(30)
                .margin({ left: 5, right: 5 })
                .onClick(() => {
                  PromptActionClass.setContext(this.getUIContext());
                  PromptActionClass.setContentNode(this.giftNode!);
                  PromptActionClass.setOptions({ alignment: DialogAlignment.BottomEnd, offset: { dx: 0, dy: 0 } });
                  PromptActionClass.openDialog();
                })
            }

            Stack() {
              if (this.functionConfig?.watch_hide_like == 0) {
                Image($r('app.media.icon_like'))
                  .width(30)
                  .height(30)
                  .margin({ right: 5 })
                  .onClick(() => {
                    this.likeCount++;
                    this.clickLikeNumber++;
                    this.timer?.cancel();
                    this.timer?.start();
                    // åœ¨æŒ‰é’®ä¸­å¿ƒä¸Šæ–¹50pxä½ç½®ç”Ÿæˆæ°”æ³¡
                    // è·å–æŒ‰é’®å®é™…ä½ç½®
                    const buttonWidth = 10
                    const buttonHeight = 10
                    const btnCenterX = (this.context.width * 0.9) + buttonWidth / 2
                    const btnCenterY = (this.context.height * 0.9) + buttonHeight / 2
                    // åœ¨æŒ‰é’®ä¸­å¿ƒç”Ÿæˆæ°”æ³¡ï¼Œå¹¶é™åˆ¶éšæœºåç§»èŒƒå›´
                    const maxOffset = 20
                    this.addLikeIcon(
                      btnCenterX + Math.random() * maxOffset - maxOffset / 2,
                      btnCenterY - 10 + Math.random() * maxOffset - maxOffset / 2
                    )
                  })
              }
              if (this.functionConfig?.hidden_watch_like_data == 0) {
                Text(this.likeCount > 999 ? '999+' : this.likeCount.toString())
                  .fontSize(8)
                  .fontColor(Color.White)
                  .backgroundColor(Color.Red)
                  .width(Math.max(10, 6 * this.likeCount.toString().length))
                  .height(Math.max(10, 6 * this.likeCount.toString().length))
                  .borderRadius('100%')
                  .textAlign(TextAlign.Center)
                  .position({ x: 22, y: -4 })
              }

            }

          }
          .height(54)
          .width('100%')
          .backgroundColor("#ffffff")
          .padding({ left: 10, right: 10 })
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Start)


          // if (this.agreement.is_open == 1 && this.agreement.is_agree == 0) {
          //   Blank()
          //     .height(68)
          // }
        }
        .backgroundColor("#FAFAFA")
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    // é€‚é…æµæµ·å±ï¼ˆé¡¶éƒ¨çŠ¶æ€æ é€æ˜å¹¶ç©¿è¿‡ï¼Œå¹¶é€è¿‡åº•éƒ¨ä¸Šåˆ’æ“ä½œåŒºï¼‰
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  // }
}