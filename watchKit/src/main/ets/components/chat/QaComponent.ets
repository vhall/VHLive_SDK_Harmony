import { ComponentContent, KeyboardAvoidMode } from '@kit.ArkUI';
import {
  VHLikeIcon,
  VHQuestionAnswerDeleteMsg,
  VHQuestionAnswerMsg,
  VHQuestionHistoryInfo,
  VHRoomLikeInfo,
  VHChatDisableAllMsg,
  VHContent,
  VHIMMessageModel,
  VHIMServer,
  VHMsgData,
  VHQuestionHistoryList,
  VHRoomEventType,
  VHSaaSDK,
  VHWebinarData,
  VHQuestionAnswerSetMsg,
  VHRoomToolsStatusData,
  VHConfigList
} from '@vhall/vhall_live';

import { EmitterMsgData, EmitterUtil } from '../../util/EmitterUtil';
import { ToastUtil } from "../../action/ToastUtil";
import { createGiftView } from './GiftComponent';
import { PromptActionClass } from '../../util/PromptActionClass';
import { CountDownTimer } from '../../util//CountDownTimer.ets';
import { EmojiTool } from './EmojiTool';
import ChatTools from '../../util/ChatTools';
import { QaRecommendDialog } from './QaRecommendDialog';

/**
 * é—®ç­”ç•Œé¢
 *
 */
@Component
export struct QaComponent {
  @Prop functionConfig: VHConfigList | null = null; //åŠŸèƒ½é…ç½®
  @Prop webinars: VHWebinarData | null = null;
  @State chatMessages: VHQuestionHistoryList | null = null;
  @Prop room_tool: VHRoomToolsStatusData | null = null;
  @Prop imBase: VHIMServer;
  @Prop isLive: boolean; //æ˜¯å¦ç›´æ’­
  @State avatar: string | undefined = "";
  @State inputText: string = "å¿«æ¥æé—®å§";
  @State messageInput: string = '';
  @LocalStorageLink('likeCount') likeCount: number = 0;
  @State clickLikeNumber: number = 0;
  @State chatDisable: boolean = false;
  /** èŠå¤©åˆ—è¡¨çš„æ»šåŠ¨æ¡ç»„ä»¶ */
  private scroller: Scroller = new Scroller();
  private msgSubId: number = -1; // è®¢é˜…IDï¼ˆç”¨äºå–æ¶ˆè®¢é˜…ï¼‰
  private giftNode: ComponentContent<Object> | null = null;
  private timer: CountDownTimer | null = null;
  /** èŠå¤©æ¶ˆæ¯åˆ—è¡¨å¯¹åº”çš„æ•°æ®æºå¯¹è±¡ï¼ˆæœ¬å¯¹è±¡ä¸MessageProvideré…åˆï¼Œç”¨äºå®ç°UIç•Œé¢ä¸æ•°æ®ç»„çš„è§£å¶ï¼‰*/
  @State historyData: VHQuestionHistoryInfo[] = [];
  // ç”¨æ¥é…ç½®CanvasRenderingContext2Då¯¹è±¡çš„å‚æ•°ï¼Œå¼€å¯æŠ—é”¯é½¿
  private settings: RenderingContextSettings = new RenderingContextSettings(true)
  // æ­£ç¡®åˆ›å»ºCanvasRenderingContext2Då¯¹è±¡
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings)
  @State likeIcons: VHLikeIcon[] = [] // å­˜å‚¨æ‰€æœ‰ç‚¹èµå›¾æ ‡
  private animationId: number = 0 // åŠ¨ç”»ID
  // é—®ç­”å†å²è®°å½• typeä¸ºï¼šquestion
  private qaQuestion: string = "question";
  // é—®ç­”å†å²è®°å½• typeä¸ºï¼šanswer
  private qaAnswer: string = "answer";

  // emojiè¡¨æƒ…æ•°ç»„
  private readonly emojis: string[] = [
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ',
    'ğŸ¼', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦Š',
    'ğŸ', 'ğŸ€', 'ğŸ‰', 'ğŸŠ', 'âœ¨', 'â­'
  ]
  // çŠ¶æ€ç®¡ç†ï¼šæ§åˆ¶é¢„è§ˆæ˜¾ç¤º/éšè— + å½“å‰é¢„è§ˆçš„å›¾ç‰‡URL
  @State isPreviewShow: boolean = false;
  @State currentPreviewUrl: string = '';
  @State isRecommendShow: boolean = false;
  // é—®ç­”åŒºçš„é—®é¢˜æ‰€æœ‰è§‚ä¼—å¯è§ 1å¯è§ 0ä¸å¯è§
  @State questionPublicStatus: string = '';

  aboutToAppear() {
    this.avatar = this.webinars?.join_info?.avatar;
    this.questionPublicStatus = this.room_tool!.question_public_status!.toString();
    this.getQuestionHistory();
    this.getLikeCount();
    // å¯åŠ¨åŠ¨ç”»å¾ªç¯
    this.startAnimation()
    this.initTimer();
    this.giftNode = new ComponentContent(this.getUIContext(), wrapBuilder(createGiftView), this.webinars!);
    PromptActionClass.setContext(this.getUIContext());
    PromptActionClass.setContentNode(this.giftNode);
    PromptActionClass.setOptions({ alignment: DialogAlignment.BottomEnd, offset: { dx: 0, dy: 0 } });
    // è®¢é˜…æ¶ˆæ¯
    this.subscribeCommitMessage();
    this.subscribeCreateMessage();
    this.subscribeDeleteMessage();
    this.subscribeBackOutMessage();
    this.subscribeChatDisable();
    this.subscribeLikeCount();
    this.subscribeSetMessage();
    this.subscribeLikeMessage();
    this.subscribeRecommendMessage();

    if (this.webinars?.join_info?.is_gag == 1 || this.room_tool?.all_banned == 1 || this.room_tool?.is_board == 1 ||
      this.room_tool?.is_kicked == 1) {
      this.chatDisable = true;
    }

    if(this.functionConfig?.watch_record_no_chatting == 1 && this.webinars?.webinar?.type == 5){
      this.chatDisable = true;
    }
  }

  QaRecommendDialog = new CustomDialogController({
    builder: QaRecommendDialog({ webinars: this.webinars ? this.webinars : undefined }),
    customStyle: true,
    alignment: DialogAlignment.Bottom
  })

  /**
   * ç•Œé¢è¢«é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚
   */
  aboutToDisappear() {
    // this.setKeyboardAvoidModeToRESIZE(this.getUIContext(), false);
    this.timer?.cancel();
    // æ¸…é™¤åŠ¨ç”»å¾ªç¯
    clearInterval(this.animationId);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_COMMIT);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_CREATE);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_DELETE);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_BACKOUT);
    EmitterUtil.unsubscribe(VHRoomEventType.CUSTOM_PRAISE);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_SET);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_LIKE);
    EmitterUtil.unsubscribe(VHRoomEventType.QUESTION_ANSWER_RECOMMEND);
  }

  subscribeLikeCount() {
    EmitterUtil.subscribe(VHRoomEventType.CUSTOM_PRAISE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°ç‚¹èµæ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.IM_TEXT}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        this.handleLikeCount(messageModel.data);
      }
    });
  }

  subscribeSetMessage() {
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_SET, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°æ˜¯å¦å¼€å¯æ‰€æœ‰è§‚ä¼—å¯è§æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_SET}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        let message: VHQuestionAnswerSetMsg = messageModel.data as VHQuestionAnswerSetMsg;
        this.questionPublicStatus = message.question_public_status;
        this.getQuestionHistory();
      }
    });
  }

  subscribeLikeMessage() {
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_LIKE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°ç‚¹å‡»æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_LIKE}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        this.getQuestionHistory();
      }
    });
  }

  subscribeRecommendMessage() {
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_RECOMMEND, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°æ¨èæ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_RECOMMEND}`);
      let messageModel: VHIMMessageModel = msgData as VHIMMessageModel;
      if (messageModel.data!) {
        this.isRecommendShow = true;
        this.getQuestionHistory();
      }
    });
  }


  subscribeCreateMessage() {
    // æ¥æ”¶é—®ç­”æ¶ˆæ¯
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_CREATE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°é—®ç­”æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_CREATE}`);
      let qaMsg: VHQuestionAnswerMsg = msgData.data as VHQuestionAnswerMsg;
      if (qaMsg!) {
        if (typeof qaMsg === 'string') {
          const parsedMessage: VHQuestionAnswerMsg = JSON.parse(qaMsg) as VHQuestionAnswerMsg;
          this.handleQAMessage(parsedMessage, VHRoomEventType.QUESTION_ANSWER_CREATE);
        } else {
          this.handleQAMessage(qaMsg, VHRoomEventType.QUESTION_ANSWER_CREATE);
        }
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });
  }

  subscribeCommitMessage() {
    // ä¸»æŒäººï¼šé€šè¿‡å¹¶å›å¤æ¶ˆæ¯,ç›´æ’­ä¸­å›ç­”
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_COMMIT, (msgData: EmitterMsgData) => {
      console.log(`ä¸»æŒäººï¼šé€šè¿‡å¹¶å›å¤æ¶ˆæ¯,ç›´æ’­ä¸­å›ç­”ï¼š${VHRoomEventType.QUESTION_ANSWER_COMMIT}`);
      let qaMsg: VHQuestionAnswerMsg = msgData.data as VHQuestionAnswerMsg;
      if (qaMsg!) {
        if (typeof qaMsg === 'string') {
          const parsedMessage: VHQuestionAnswerMsg = JSON.parse(qaMsg) as VHQuestionAnswerMsg;
          this.handleQAMessage(parsedMessage, VHRoomEventType.QUESTION_ANSWER_COMMIT);
        } else {
          this.handleQAMessage(qaMsg, VHRoomEventType.QUESTION_ANSWER_COMMIT);
        }
        // å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
      }
    });
  }

  subscribeDeleteMessage() {
    // æ¥æ”¶åˆ é™¤é—®ç­”æ¶ˆæ¯
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_DELETE, (msgData: EmitterMsgData) => {
      console.log(`æ”¶åˆ°åˆ é™¤é—®ç­”æ¶ˆæ¯ï¼Œç±»å‹ï¼š${VHRoomEventType.QUESTION_ANSWER_DELETE}`);
      let qaMsg: VHQuestionAnswerDeleteMsg = msgData.data as VHQuestionAnswerDeleteMsg;
      if (qaMsg!) {
        if (typeof qaMsg === 'string') {
          qaMsg = JSON.parse(qaMsg) as VHQuestionAnswerDeleteMsg;
        }
        let question_ids: string = qaMsg.question_ids;
        if (question_ids.length > 0) {
          this.historyData = this.historyData.filter(item => !question_ids.includes(item.id));
        }
      }
    });
  }

  subscribeBackOutMessage() {
    // ä¸»æŒäººï¼šæ’¤é”€å›å¤
    EmitterUtil.subscribe(VHRoomEventType.QUESTION_ANSWER_BACKOUT, (msgData: EmitterMsgData) => {
      console.log(`ä¸»æŒäººï¼šæ’¤é”€å›å¤ï¼š${VHRoomEventType.QUESTION_ANSWER_BACKOUT}`);
      let qaMsg: VHQuestionAnswerMsg = msgData.data as VHQuestionAnswerMsg;
      if (qaMsg!) {
        if (typeof qaMsg === 'string') {
          qaMsg = JSON.parse(qaMsg) as VHQuestionAnswerMsg;
        }
        let question_answer_id = qaMsg.question_answer_id;
        const newData: VHQuestionHistoryInfo[] =
          this.historyData.filter(item => (item.answer === undefined || item.answer!.id !== question_answer_id));
        this.historyData = newData;
      }
    });
  }

  //è®¢é˜…ç¦è¨€äº‹ä»¶
  subscribeChatDisable() {
    EmitterUtil.subscribe(VHRoomEventType.CHAT_DISABLE, (msgData: EmitterMsgData) => {
      this.chatDisable = true;
    });
    EmitterUtil.subscribe(VHRoomEventType.CHAT_PERMIT, (msgData: EmitterMsgData) => {
      this.chatDisable = false;
    });

    EmitterUtil.subscribe(VHRoomEventType.CHAT_DISABLE_ALL, (msgData: EmitterMsgData) => {
      let chatDisableAllMsg: VHChatDisableAllMsg = msgData.data as VHChatDisableAllMsg;
      if (chatDisableAllMsg != null && chatDisableAllMsg.qa_status === 1) {
        this.chatDisable = true;
      }
    });
    EmitterUtil.subscribe(VHRoomEventType.CHAT_PERMIT_ALL, (msgData: EmitterMsgData) => {
      let chatDisableAllMsg: VHChatDisableAllMsg = msgData.data as VHChatDisableAllMsg;
      if (chatDisableAllMsg != null && chatDisableAllMsg.qa_status === 1) {
        this.chatDisable = false;
      }
    });
  }

  handleLikeCount(msg?: VHIMMessageModel) {
    if (!msg) {
      return;
    }
    // æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
    let imMsg: VHContent = msg as VHContent;
    imMsg.data = msg.data as VHMsgData;
    // æ¥æ”¶ç‚¹èµæ•°
    if (imMsg.data!.event_type === VHRoomEventType.CUSTOM_PRAISE && imMsg.data!.num! > 0) {
      this.likeCount = imMsg.data.num;
    }
  }

  handleQAMessage(msg: VHQuestionAnswerMsg, type: string) {
    if (!msg) {
      return;
    }
    let answer: VHQuestionHistoryInfo = msg.answer as VHQuestionHistoryInfo;
    let qaInfo: VHQuestionHistoryInfo =
      new VHQuestionHistoryInfo(type, msg.nick_name, msg.content, msg.created_time,
        msg.avatar, answer, msg.id.toString());
    // é—®ç­”åŒºçš„é—®é¢˜æ‰€æœ‰è§‚ä¼—å¯è§,ä¸”æé—®ç›¸åŒ
    if (this.questionPublicStatus === '1') {
      this.historyData.push(qaInfo);
    } else if (msg.nick_name === this.webinars?.join_info?.nickname) {
      // å¦‚é—®ç­”åŒºçš„é—®é¢˜æ‰€æœ‰è§‚ä¼—ä¸å¯è§ï¼Œåªæœ‰è‡ªå·±å¯è§
      this.historyData.push(qaInfo);
    }
  }

  getQuestionHistory() {
    VHSaaSDK.getInstance()
      .getQuestionHistory(this.webinars?.interact?.room_id!, {
        onSucceed: (data: VHQuestionHistoryList) => {
          this.chatMessages = data;
          this.historyData=[];
          this.changeChatMessage(data);
        },
        onFailure: (errorCode, errorMsg) => {
          console.log("èŠå¤©è·å¾—å†å²è®°å½•å¤±è´¥ï¼š", errorMsg)
          ToastUtil.showToast(errorMsg);
        }
      });
  }

  getLikeCount() {
    VHSaaSDK.getInstance().getRoomLike(this.webinars?.interact?.room_id!, {
      onSucceed: (data: VHRoomLikeInfo) => {
        this.likeCount = Number(data.total);
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("èŠå¤©è·å¾—å†å²è®°å½•å¤±è´¥ï¼š", errorMsg)
        ToastUtil.showToast(errorMsg);
      }
    });
  }

  //è®¾ç½®é—®å·åŒé—®
  setQaLike(questionId: string, likeStatus: string) {
    VHSaaSDK.getInstance().setQaLike(this.webinars!.webinar!.id!.toString(), questionId, likeStatus, {
      onSuccess: (data: string | object) => {
        console.log("è®¾ç½®ç‚¹èµæ•°æˆåŠŸ");
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("è®¾ç½®ç‚¹èµæ•°å¤±è´¥ï¼š", errorMsg)
        ToastUtil.showToast(errorMsg);
      }
    });
  }

  userLike() {
    VHSaaSDK.getInstance().createUserLikeWithRoomId(this.webinars?.interact?.room_id!, this.clickLikeNumber.toString(), {
      onSuccess: (data: string | object) => {
        console.log("å¢åŠ ç‚¹èµæ•°ï¼š", this.clickLikeNumber);
      },
      onFailure: (errorCode, errorMsg) => {
        console.log("å¢åŠ ç‚¹èµæ•°å¤±è´¥ï¼š", errorMsg)
        ToastUtil.showToast(errorMsg);
      }
    });
  }

  sendQuestion() {
    VHSaaSDK.getInstance().sendQuestion(this.webinars?.interact?.room_id!, this.messageInput, {
      onSuccess: (data: string | object) => {
        console.log("æ¶ˆæ¯å‘é€æˆåŠŸ");
        this.messageInput = '';
        // æ”¶èµ·è½¯é”®ç›˜
        this.hideSoftInputMethod(this.getUIContext());
        //å»¶è¿Ÿæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿UIå·²æ›´æ–°ï¼‰
        setTimeout(() => {
          this.scrollToBottom();
        }, 200);
      },
      onFailure: (errorCode, errorMsg) => {
        ToastUtil.showToast("15ç§’å†…ä¸å¯æé—®!");
      }
    });
  }

  changeChatMessage(data: VHQuestionHistoryList) {
    // è½¬æ¢æ¨¡å‹
    let array = data?.list;
    if (Array.isArray(array)) {
      array.forEach((obj: object) => {
        let qaInfo = obj as VHQuestionHistoryInfo;
        if (qaInfo != null) {
          this.historyData.push(qaInfo);
        }
      });
      if (this.isRecommendShow === false) {
        array.forEach((obj: object) => {
          let qaInfo = obj as VHQuestionHistoryInfo;
          if (qaInfo != null && qaInfo.recommend_status == 1) {
            this.isRecommendShow = true;
            return;
          }
        });
      }
    }
  }

  formatTime(dateTime: string): string {
    return dateTime.substring(dateTime.lastIndexOf(" "));
  }

  /**
   * æ»šåŠ¨æ¶ˆæ¯åˆ—è¡¨åˆ°æœ€åº•éƒ¨ï¼Œä»¥å¤‡æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯ã€‚
   */
  scrollToBottom() {
    this.scroller.scrollEdge(Edge.Bottom);
  }

  setKeyboardAvoidModeToRESIZE(context: UIContext, toRESIZE: boolean) {
    context.setKeyboardAvoidMode(toRESIZE ? KeyboardAvoidMode.RESIZE : KeyboardAvoidMode.OFFSET);
  }

  /**
   * æ”¶åˆ°é”®ç›˜
   * @param context
   */
  hideSoftInputMethod(context: UIContext) {
    context.getFocusController().clearFocus();
  }

  // åˆå§‹åŒ–å€’è®¡æ—¶å™¨ï¼ˆæ€»æ—¶é—´2ç§’ï¼Œé—´éš”1ç§’ï¼‰
  initTimer() {
    this.timer = new CountDownTimer(2000, 1000)
    // å€’è®¡æ—¶ä¸­å›è°ƒï¼šæ›´æ–°UIå±•ç¤ºå‰©ä½™æ—¶é—´
      .onTick((remainingTime) => {
        const seconds = Math.ceil(remainingTime / 1000);
      })
      // å€’è®¡æ—¶ç»“æŸå›è°ƒï¼šæ›´æ–°ç»“æŸçŠ¶æ€
      .onFinish(() => {
        this.userLike();
        this.clickLikeNumber = 0;
      });
  }

  // åˆ›å»ºä¸€ä¸ªå›¾æ ‡å¯¹è±¡
  createIcon(x: number, y: number, radius: number, emoji: string): VHLikeIcon {
    // ä¸ºå›¾æ ‡ç”Ÿæˆéšæœºå±æ€§
    const initialScale = 0.4 + Math.random() * 0.2 // åˆå§‹ç¼©æ”¾æ¯”ä¾‹0.4-0.6
    const maxScale = 1.0 + Math.random() * 0.3 // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹1.0-1.3
    // å‡å°æ‘†åŠ¨å¹…åº¦ï¼Œæ”¹ä¸ºæœ€å¤§8-15åƒç´ 
    const maxOffset = 8 + Math.random() * 7 // æœ€å¤§æ‘†åŠ¨å¹…åº¦8-15åƒç´ 
    // éšæœºå†³å®šåˆå§‹æ‘†åŠ¨æ–¹å‘
    const direction = Math.random() > 0.5 ? 1 : -1

    return {
      x: x,
      y: y,
      initialX: x, // è®°å½•åˆå§‹Xåæ ‡
      initialY: y, // è®°å½•åˆå§‹Yåæ ‡
      radius: radius,
      emoji: emoji,
      fontSize: Math.floor(radius * 1.2),
      opacity: 1.0,
      createTime: Date.now(),
      lifespan: 1500, // å»¶é•¿ç”Ÿå‘½å‘¨æœŸè‡³1.5ç§’
      scale: initialScale, // å½“å‰ç¼©æ”¾æ¯”ä¾‹
      initialScale: initialScale, // åˆå§‹ç¼©æ”¾æ¯”ä¾‹
      maxScale: maxScale, // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
      maxOffset: maxOffset, // æœ€å¤§æ‘†åŠ¨å¹…åº¦
      direction: direction // åˆå§‹æ‘†åŠ¨æ–¹å‘
    }
  }

  // è·å–éšæœºemoji
  getRandomEmoji(): string {
    return this.emojis[Math.floor(Math.random() * this.emojis.length)]
  }

  // æ·»åŠ æ–°çš„ç‚¹èµå›¾æ ‡
  addLikeIcon(baseX: number, baseY: number) {
    const radius = 80 + Math.random() * 20
    const emoji = this.getRandomEmoji()
    // æ·»åŠ éšæœºä½ç½®åç§»ï¼ˆÂ±15pxèŒƒå›´å†…ï¼‰
    const offsetX = Math.random() * 30 - 15
    const offsetY = Math.random() * 30 - 15
    this.likeIcons.push(this.createIcon(baseX + offsetX, baseY + offsetY, radius, emoji))
  }

  // å¼€å§‹åŠ¨ç”»å¾ªç¯
  startAnimation() {
    this.animationId = setInterval(() => {
      this.updateIcons()
      this.drawAllIcons()
    }, 16) // çº¦60fpsçš„åˆ·æ–°ç‡
  }

  // æ›´æ–°æ‰€æœ‰å›¾æ ‡çŠ¶æ€
  updateIcons() {
    const currentTime = Date.now()
    const newIcons: VHLikeIcon[] = []

    for (let icon of this.likeIcons) {
      // è®¡ç®—å›¾æ ‡å·²å­˜åœ¨çš„æ—¶é—´
      const existTime = currentTime - icon.createTime

      if (existTime < icon.lifespan) {
        // è®¡ç®—å­˜åœ¨æ—¶é—´æ¯”ä¾‹
        const progress = existTime / icon.lifespan

        // 1. æ›´æ–°Yåæ ‡ - å‘ä¸Šç§»åŠ¨ï¼Œé€Ÿåº¦å˜åŒ–æ›´æ˜æ˜¾
        const verticalDistance = 200 * Math.pow(progress, 0.5) // å‡ç¼“ä¸Šå‡é€Ÿåº¦ // ä½¿ç”¨å¹‚å‡½æ•°è®©ä¸Šå‡æ›´å¿«
        icon.y = icon.initialY - verticalDistance

        // 2. æ›´æ–°Xåæ ‡ - å¿«é€Ÿçš„å·¦å³æ‘†åŠ¨
        // æ¯0.25ç§’ä¸€ä¸ªé˜¶æ®µï¼Œæ€»å…±1ç§’4ä¸ªé˜¶æ®µ
        let horizontalOffset = 0;

        if (progress < 0.25) {
          // 0-0.25s: æ— åç§»ï¼Œä¸“æ³¨äºæ”¾å¤§
          horizontalOffset = 0;
        } else if (progress < 0.5) {
          // 0.25-0.5s: å‘å·¦åç§»
          const phaseProgress = (progress - 0.25) / 0.25;
          horizontalOffset = -icon.maxOffset * phaseProgress * icon.direction;
        } else if (progress < 0.75) {
          // 0.5-0.75s: ä»å‘å·¦åç§»å˜ä¸ºå‘å³åç§»
          const phaseProgress = (progress - 0.5) / 0.25;
          horizontalOffset = icon.maxOffset * (2 * phaseProgress - 1) * icon.direction;
        } else {
          // 0.75-1s: ä»å‘å³åç§»å›åˆ°å‘å·¦åç§»
          const phaseProgress = (progress - 0.75) / 0.25;
          horizontalOffset = icon.maxOffset * (1 - 2 * phaseProgress) * icon.direction;
        }

        icon.x = icon.initialX + horizontalOffset;

        // 3. æ›´æ–°ç¼©æ”¾æ¯”ä¾‹ - å¿«é€Ÿæ”¾å¤§
        // åœ¨ç”Ÿå‘½å‘¨æœŸçš„å‰20%é˜¶æ®µ(0.2s)ï¼Œç¼©æ”¾ä»initialScaleå¢å¤§åˆ°maxScale
        if (progress < 0.2) {
          // å¹³æ»‘æ’å€¼ä»initialScaleåˆ°maxScale
          icon.scale = icon.initialScale + (icon.maxScale - icon.initialScale) * (progress / 0.2)
        } else {
          // ä¿æŒmaxScale
          icon.scale = icon.maxScale
        }

        // 4. æ›´æ–°é€æ˜åº¦ - å‰60%ä¿æŒä¸å˜ï¼Œå40%é€æ¸æ¶ˆå¤±
        if (progress > 0.6) {
          // åœ¨æœ€å40%çš„ç”Ÿå‘½å‘¨æœŸå†…æ”¹å˜é€æ˜åº¦ï¼Œä½¿æ¶ˆå¤±æ›´å¿«
          icon.opacity = 1.0 - ((progress - 0.6) / 0.4)
        } else {
          icon.opacity = 1.0
        }

        // ä¿ç•™æœªå®Œæˆç”Ÿå‘½å‘¨æœŸçš„å›¾æ ‡
        newIcons.push(icon)
      }
    }

    // æ›´æ–°å›¾æ ‡æ•°ç»„
    this.likeIcons = newIcons
  }

  // ç»˜åˆ¶æ‰€æœ‰å›¾æ ‡
  drawAllIcons() {
    // æ¸…é™¤ç”»å¸ƒ
    this.context.clearRect(0, 0, this.context.width, this.context.height)

    // ç»˜åˆ¶æ‰€æœ‰å›¾æ ‡
    for (let icon of this.likeIcons) {
      this.context.save()

      // è®¾ç½®é€æ˜åº¦
      this.context.globalAlpha = icon.opacity

      // è®¾ç½®ç¼©æ”¾ï¼ˆä»ä¸­å¿ƒç‚¹ç¼©æ”¾ï¼‰
      this.context.translate(icon.x, icon.y)
      this.context.scale(icon.scale, icon.scale)
      this.context.translate(-icon.x, -icon.y)

      // ç»˜åˆ¶emoji
      this.context.font = `${icon.fontSize}px`
      this.context.textAlign = 'center'
      this.context.textBaseline = 'middle'
      this.context.fillText(icon.emoji, icon.x, icon.y)

      this.context.restore()
    }
  }

  // ç‚¹å‡»åˆ—è¡¨å›¾ç‰‡ï¼šæ‰“å¼€é¢„è§ˆ
  openImagePreview(url: string) {
    this.currentPreviewUrl = url;
    this.isPreviewShow = true;
  }

  // ç‚¹å‡»èŠå¤©åˆ—è¡¨ï¼šå…³é—­é¢„è§ˆ
  closeImagePreview() {
    this.isPreviewShow = false;
  }

  build() {
    Column() {
      // Stack() {
      // èŠå¤©ç•Œé¢å†…å®¹åŒº
      Column() {
        List({ space: 4, scroller: this.scroller }) {
          ForEach(this.historyData, (item: VHQuestionHistoryInfo, index) => {
            ListItem() {
              Column({ space: 8 }) {
                // æé—®
                if (item.type === this.qaQuestion ||
                  item.type === VHRoomEventType.QUESTION_ANSWER_CREATE)
                Row() {
                  Image(item.avatar === '' ? $r("app.media.icon_visitorvatar") : item.avatar)
                    .width(30)
                    .height(30)
                    .borderRadius(20)
                  Column() {
                      Row() {
                        Text(ChatTools.getLimitString(item.nick_name, 8))
                          .fontColor(Color.Gray).fontSize(12).padding({ right: 10 })
                        if (item.created_time!.length > 0) {
                          Text(this.formatTime(item.created_time))
                            .fontColor(Color.Gray)
                            .fontSize(12)
                            .layoutWeight(1)
                            .padding({ right: 10 })
                            .textAlign(TextAlign.End)
                        }
                      }

                      Column() {
                        Text(EmojiTool.convertEmojiTags(item.content!))
                          .fontSize(12)
                          .textAlign(TextAlign.Start)
                          .padding({ left: 5 })
                          .backgroundColor(Color.White)
                          .padding({left: 4,right: 4,top: 2,bottom: 2})
                      }
                      .width('98%')
                      .margin({ right: 10 })
                      .justifyContent(FlexAlign.Start)
                      .alignItems(HorizontalAlign.Start)
                  }
                  .width('98%')
                  .padding({ left: 8, right: 8 })
                  .margin({ top: 2 })
                  .borderRadius(8)
                  .alignItems(HorizontalAlign.Start)
                  .justifyContent(FlexAlign.Start)
                }
                .width('98%')
                .padding({right: 10})
                .justifyContent(FlexAlign.Start)
                .alignItems(VerticalAlign.Top)

                //  æé—®
                if (item.type === this.qaAnswer ||
                  item.type === VHRoomEventType.QUESTION_ANSWER_COMMIT)
                Row() {
                  Image(item.avatar === '' ? $r("app.media.icon_visitorvatar") : item.avatar)
                    .width(30)
                    .height(30)
                    .borderRadius(20)
                  Column() {
                    Row() {
                      Text(ChatTools.getLimitString(item.nick_name, 8))
                        .fontColor(Color.Gray).fontSize(12).padding({ right: 10 })
                      if (item.created_time!.length > 0) {
                        Text(this.formatTime(item.created_time))
                          .fontColor(Color.Gray)
                          .fontSize(12)
                          .layoutWeight(1)
                          .padding({ right: 10 })
                          .textAlign(TextAlign.End)
                      }
                    }

                    Column() {
                      Row() {
                        Text() {
                          Span('æé—® ').fontColor(Color.Red)
                          Span(EmojiTool.convertEmojiTags(item.content!)).fontColor(Color.Black)
                        }
                        .fontSize(12)
                        .textAlign(TextAlign.Start)
                        .backgroundColor(Color.White)
                      }.justifyContent(FlexAlign.Start).alignItems(VerticalAlign.Top)

                      //  å›å¤
                      if (item.type === this.qaAnswer ||
                        item.type === VHRoomEventType.QUESTION_ANSWER_COMMIT)
                      Column() {
                        Row() {
                          Image(item.answer?.avatar)
                            .width(30)
                            .height(30)
                            .borderRadius(20)
                          Column() {
                            Row() {
                              Text(ChatTools.getLimitString(item.answer!.nick_name, 8))
                                .fontColor(Color.Gray).fontSize(12).padding({ right: 10 })
                              Text(ChatTools.changeRoleToRoleName(item.answer!.role_name))
                                .fontColor(Color.Red)
                                .fontSize(12)
                                .borderRadius(8)
                                .backgroundColor('#FFE6F2')
                                .padding({
                                  top: 2,
                                  left: 4,
                                  right: 4,
                                  bottom: 2
                                })
                            }

                            Row() {
                              Text() {
                                Span('å›å¤ ').fontColor(Color.Red)
                                Span(EmojiTool.convertEmojiTags(item.answer?.content!)).fontColor(Color.Black)
                              }
                                .fontSize(12)
                                .textAlign(TextAlign.Start)
                                .padding({
                                  top: 2,
                                  left: 6,
                                  right: 2,
                                  bottom: 2
                                })
                                .layoutWeight(1)
                            } .width('98%') .alignItems(VerticalAlign.Top)
                          }
                          .alignItems(HorizontalAlign.Start)
                          .padding({ left: 6 })
                          .width('95%')
                        }
                        .padding(8)
                        .borderRadius(8)
                        .alignItems(VerticalAlign.Top)
                        .justifyContent(FlexAlign.Start)
                      }
                      .width('100%')

                    }
                    .width('98%')
                    .padding(4)
                    .justifyContent(FlexAlign.Start)
                    .alignItems(HorizontalAlign.Start)
                    .backgroundColor(Color.White)
                  }
                  .width('98%')
                  .margin({ top: 2 })
                  .padding({left:8,right:8})
                  .borderRadius(8)
                  .alignItems(HorizontalAlign.Start)
                  .justifyContent(FlexAlign.Start)
                }
                .width('98%')
                .padding({right: 10})
                .justifyContent(FlexAlign.Start)
                .alignItems(VerticalAlign.Top)

                // åŒé—®
                Row() {
                  Text() {
                    SymbolSpan(item.like_status > 0 ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
                      .fontWeight(FontWeight.Lighter)
                      .renderingStrategy(SymbolRenderingStrategy.SINGLE)
                      .fontSize(12)
                      .fontColor(item.like_status > 0 ? [Color.Red] : [Color.Black])
                  }
                  Text('åŒé—®')
                    .fontColor(Color.Red)
                    .fontSize(12)
                    .fontColor(item.like_status > 0 ? Color.Red : Color.Black)
                  Text(item.like_count.toString()).fontSize(12).fontColor(item.like_status > 0 ? Color.Red : Color.Black)
                }
                .width('100%')
                .padding({ right: 10 })
                .justifyContent(FlexAlign.End)
                .onClick(() => {
                  if (item.nick_name === this.webinars?.join_info?.nickname!) {
                    ToastUtil.showToast("ä¸æ”¯æŒå¯¹è‡ªå·±å‘çš„é—®é¢˜è¿›è¡ŒåŒé—®ï¼");
                    return;
                  }
                  let likeStatus = item.like_status > 0 ? '0' : '1';
                  this.setQaLike(item.id, likeStatus);
                })
              }.width('100%')
            }
          }
          )
        }
        .width('100%')
        .height('80%')
        // ç›‘å¬ç»„ä»¶è§¦å±äº‹ä»¶ï¼Œç¡®ä¿è§¦ç¢°èŠå¤©åˆ—è¡¨æ—¶ï¼Œèƒ½è‡ªåŠ¨æ”¶èµ·è¾“å…¥æ³•è½¯é”®ç›˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
        .onTouch((event: TouchEvent) => {
          // æ”¶èµ·è½¯é”®ç›˜
          this.hideSoftInputMethod(this.getUIContext());
          // ç‚¹å‡»åˆ—è¡¨å…³é—­é¢„è§ˆ
          this.closeImagePreview();
        })
        // ç›‘å¬ç»„ä»¶å¤§å°å˜åŒ–äº‹ä»¶ï¼ˆç”¨äºå®ç°å½“è½¯é”®ç›˜æ˜¾ç¤ºæ—¶ï¼Œåˆ—è¡¨é«˜åº¦è¢«å‹ç¼©åï¼Œæ¶ˆæ¯ä¸èƒ½è‡ªåŠ¨æ˜¾ç¤ºæœ€åä¸€æ¡çš„é—®é¢˜ï¼‰
        .onSizeChange((oldValue: SizeOptions, newValue: SizeOptions) => {
          let oldHeight = oldValue.height, newHeight = newValue.height;
          oldHeight = (oldHeight === undefined ? 0 : oldHeight);
          newHeight = (newHeight === undefined ? 0 : newHeight);
          // åˆ—è¡¨é«˜åº¦å˜å°ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯è½¯é”®ç›˜æ˜¾ç¤ºäº†
          let toBeSmall = (newHeight > 0 && newHeight < oldHeight);
          if (toBeSmall) {
            // æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æœ€æ–°ä¸€æ¡æ¶ˆæ¯è¢«æ˜¾ç¤º
            this.scrollToBottom();
          }
        })
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .width("100%")
        .height('100%')
        .layoutWeight(1)
        .listDirection(Axis.Vertical)
        .zIndex(100) // ä¿æŒæœ€é«˜å±‚çº§

        Canvas(this.context)
          .width('100%')
          .height('80%')  // è¿›ä¸€æ­¥å‡å°‘é«˜åº¦
          .position({ x: 0, y: 0 })
          // .position({ type: 'absolute' })
          .zIndex(0)
          .backgroundColor(Color.Transparent)
          .onReady(() => {
            console.info(`Canvas size: ${this.context.width} x ${this.context.height}`)
          })

        // åº•éƒ¨æ¶ˆæ¯è¾“å…¥åŒº
        Row() {
          Image(this.avatar)
            .width(30)
            .height(30)
            .borderRadius(20)

          TextInput({
            placeholder: this.chatDisable ? "æ‚¨å·²è¢«ç¦è¨€" : "å¿«æ¥æé—®å§", text: $$this.messageInput
          })
            .width('70%')
            .height(34)
            .backgroundColor('#EEEEEE')
            .fontSize(15)
            .layoutWeight(1)
            .borderRadius(8)
            .margin({ left: 5, right: 5 })
            .placeholderFont({ size: 14 })
            .placeholderColor('#a1a7af')
            .enabled(!this.chatDisable)
            .onChange((msg: string) => {
              this.messageInput = msg
            })

          Button("æäº¤", { type: ButtonType.Normal, stateEffect: true })
            .width(44)
            .height(34)
            .borderRadius(8)
            .padding(0)
            .fontSize(14)
            .backgroundColor('#00de7a')
            .fontWeight(500)
            .enabled(!this.chatDisable)
            .onClick(() => {
              this.sendQuestion();
            });

          if (this.isRecommendShow)
          Image($r('app.media.icon_recommend'))
            .width(30)
            .height(30)
            .objectFit(ImageFit.Cover)
            .margin({ left: 5, right: 5 })
            .backgroundColor(Color.White)
            .onClick(() => {
              this.QaRecommendDialog.open();
            })
          if (this.isLive)
          Image($r('app.media.icon_gift'))
            .width(30)
            .height(30)
            .margin({ left: 5, right: 5 })
            .onClick(() => {
              PromptActionClass.setContext(this.getUIContext());
              PromptActionClass.setContentNode(this.giftNode!);
              PromptActionClass.setOptions({ alignment: DialogAlignment.BottomEnd, offset: { dx: 0, dy: 0 } });
              PromptActionClass.openDialog();
            })

          if (this.isLive)
          Stack() {
            Image($r('app.media.icon_like'))
              .width(30)
              .height(30)
              .margin({ left: 5, right: 5 })
              .onClick(() => {
                this.likeCount++;
                this.clickLikeNumber++;
                this.timer?.cancel();
                this.timer?.start();
                // åœ¨æŒ‰é’®ä¸­å¿ƒä¸Šæ–¹50pxä½ç½®ç”Ÿæˆæ°”æ³¡
                // è·å–æŒ‰é’®å®é™…ä½ç½®
                const buttonWidth = 10
                const buttonHeight = 10
                const btnCenterX = (this.context.width * 0.9) + buttonWidth / 2
                const btnCenterY = (this.context.height * 0.9) + buttonHeight / 2
                // åœ¨æŒ‰é’®ä¸­å¿ƒç”Ÿæˆæ°”æ³¡ï¼Œå¹¶é™åˆ¶éšæœºåç§»èŒƒå›´
                const maxOffset = 20
                this.addLikeIcon(
                  btnCenterX + Math.random() * maxOffset - maxOffset / 2,
                  btnCenterY - 10 + Math.random() * maxOffset - maxOffset / 2
                )
              })

            Text(this.likeCount > 999 ? '999+' : this.likeCount.toString())
              .fontSize(8)
              .fontColor(Color.White)
              .backgroundColor(Color.Red)
              .width(Math.max(10, 6 * this.likeCount.toString().length))
              .height(Math.max(10, 6 * this.likeCount.toString().length))
              .borderRadius('100%')
              .textAlign(TextAlign.Center)
              .position({ x: 22, y: -4 })

          }

        }
        .height(54)
        .width('100%')
        .backgroundColor("#ffffff")
        .padding({ left: 10, right: 10 })
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.Start)
      }
      .backgroundColor('#EEEEEE')
      .layoutWeight(1)

      // }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    // é€‚é…æµæµ·å±ï¼ˆé¡¶éƒ¨çŠ¶æ€æ é€æ˜å¹¶ç©¿è¿‡ï¼Œå¹¶é€è¿‡åº•éƒ¨ä¸Šåˆ’æ“ä½œåŒºï¼‰
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}